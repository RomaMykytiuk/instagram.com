{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ì–æ–ª–æ–≤–Ω–∞</title>
  <link rel="stylesheet" href="{% static 'styles_home.css' %}">
</head>
<body>

  <!-- üß≠ –õ—ñ–≤–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å -->
  <div class="sidebar">
    <ul>
      <li><a href="{% url 'post:home' %}"><img src="{% static 'img/home.svg' %}" alt="home"> –ì–æ–ª–æ–≤–Ω–∞</a></li>
      <li><a href="{% url 'post:create_post' %}"><img src="{% static 'img/search.svg' %}" alt="search"> –ü–æ—à—É–∫</a></li>
      <li><a href="{% url 'post:create_post' %}"><img src="{% static 'img/notify.svg' %}" alt="notify"> –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</a></li>
      <li><a href="{% url 'post:create_post' %}"><img src="{% static 'img/plus.svg' %}" alt="create"> –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
      <li><a href="{% url 'user:profile' request.user.username %}"><img src="{% static 'img/user.svg' %}" alt="profile"> –ü—Ä–æ—Ñ—ñ–ª—å</a></li>
    </ul>
  </div>

  <!-- üìú –°—Ç—Ä—ñ—á–∫–∞ –¥–æ–ø–∏—Å—ñ–≤ -->
  <div class="feed-container">
    {% for post in posts %}
      <div class="post-card">

        <!-- üë§ –ê–≤—Ç–æ—Ä -->
        <div class="post-header">
          <img src="{% static 'img/default_avatar.png' %}" class="avatar" alt="avatar">
          <span class="username">{{ post.author.username }}</span>
        </div>

        <!-- üñºÔ∏è –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
        {% if post.images.all %}
        <div class="post-images">
          {% for image in post.images.all %}
            <img src="{{ image.image.url }}" class="post-image" alt="post image">
          {% endfor %}
        </div>
        {% endif %}


        <div id="like-container-{{ post.id }}">
  <button type="button" data-url="{% url 'post:like_post_ajax' post.id %}" id="like-btn-{{ post.id }}">
  {% if post.is_liked  %}
      ‚ù§
    {% else %}
      ‚ù§Ô∏è
    {% endif %}
  </button>
  <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span> –ª–∞–π–∫—ñ–≤
</div>


        <!-- ‚úçÔ∏è –ü—ñ–¥–ø–∏—Å -->
        <div class="caption">
          <strong>{{ post.author.username }}</strong> {{ post.caption }}
        </div>

        <!-- üè∑Ô∏è –¢–µ–≥–∏ -->
        {% if post.post_tags.all %}
        <div class="tags">
          {% for tag in post.post_tags.all %}
            <span class="tag">#{{ tag.tag.name }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <!-- üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
        <div class="comments">
          {% for comment in post.comments.all %}
            <div class="comment">
              <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
            </div>
          {% empty %}
            <div class="comment-empty">–©–µ –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–æ–∫–æ–º–µ–Ω—Ç—É–≤–∞–≤ üôà</div>
          {% endfor %}
        </div>

        <!-- üìù –§–æ—Ä–º–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ -->
        <form method="POST" class="comment-form">
          {% csrf_token %}
          <input type="hidden" name="post_id" value="{{ post.id }}">
          {{ comment_form.content }}
          <button type="submit" class="comment-submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </form>

      </div>
    {% endfor %}
  </div>

  <!-- üîó JavaScript -->
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.querySelectorAll('[id^="like-btn-"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
        const url = btn.getAttribute('data-url');
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            btn.textContent = data.is_liked ? '‚ù§' : '‚ù§Ô∏è';
            const postId = btn.id.split('-')[2];
            document.getElementById('like-count-' + postId).textContent = data.likes_count;
        })
        .catch(error => {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –ª–∞–π–∫—É");
        });
    });
});
</script>

</body>
</html>