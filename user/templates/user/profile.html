{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>{{ profile_user.username }} ‚Ä¢ –ü—Ä–æ—Ñ—ñ–ª—å</title>
  <link rel="stylesheet" href="{% static 'styles_profile.css' %}">
</head>
<body>

  <!-- üîç –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å -->
  <div class="sidebar">
    <ul>
      <li><a href="{% url 'post:home' %}"><img src="{% static 'img/home.svg' %}" alt="home"> –ì–æ–ª–æ–≤–Ω–∞</a></li>
      <li><a href="{% url 'post:create_post' %}"><img src="{% static 'img/search.svg' %}" alt="search"> –ü–æ—à—É–∫</a></li>
      <li><a href="{% url 'post:create_post' %}"><img src="{% static 'img/notify.svg' %}" alt="notify"> –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</a></li>
      <li><a href="{% url 'post:create_post' %}"><img src="{% static 'img/plus.svg' %}" alt="create"> –°—Ç–≤–æ—Ä–∏—Ç–∏</a></li>
      <li><a href="{% url 'user:profile' request.user.username %}"><img src="{% static 'img/user.svg' %}" alt="profile"> –ü—Ä–æ—Ñ—ñ–ª—å</a></li>
    </ul>
  </div>

  <!-- üë§ –ü—Ä–æ—Ñ—ñ–ª—å -->
  <div class="feed-container">
    <div class="profile-header">
      <img src="{% static 'img/default_avatar.png' %}" class="profile-avatar-large" alt="avatar">

      <div class="profile-meta">
        <div class="profile-username-row">
          <h2>{{ profile_user.username }}</h2>
          {% if request.user != profile_user %}
            <button id="follow-btn"
                    class="profile-button"
                    data-username="{{ profile_user.username }}">
              {% if is_following %}
                –í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—å
              {% else %}
                –í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏
              {% endif %}
            </button>
          {% else %}
            <a href="{% url 'user:edit_profile' username=profile_user.username %}" class="profile-button">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
          {% endif %}
        </div>

        <div class="profile-stats">
          <span><strong>{{ posts_count }}</strong> –¥–æ–ø–∏—Å–∏</span>
          <span><strong id="followers-count">{{ followers_count }}</strong> –ø—ñ–¥–ø–∏—Å–Ω–∏–∫–∏</span>
          <span><strong>{{ following_count }}</strong> –ø—ñ–¥–ø–∏—Å–∫–∏</span>
        </div>

        <p class="profile-fullname">{{ profile_user.full_name }}</p>
      </div>
    </div>

    <!-- üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è -->
    <div class="profile-gallery">
      {% for post in posts %}
        {% for image in post.images.all %}
          <div class="gallery-item">
            <img src="{{ image.image.url }}" alt="post image" class="gallery-image">

            <div class="gallery-info">
              <div class="gallery-likes">‚ù§Ô∏è {{ post.like_set.count }}</div>
              <div class="gallery-tags">
                {% for tag in post.post_tags.all %}
                  <span class="tag">#{{ tag.tag.name }}</span>
                {% endfor %}
              </div>
              <div class="gallery-caption">
                <strong>{{ post.author.username }}</strong>: {{ post.caption }}
              </div>
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>

  <!-- ‚ö° AJAX –ª–æ–≥—ñ–∫–∞ -->
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("follow-btn");
    if (!btn) return;

    // CSRF –∑ cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    btn.addEventListener("click", function () {
      const username = btn.dataset.username;
      const action = btn.textContent.trim() === "–í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏" ? "follow" : "unfollow";

      fetch(`/follow/${action}/${username}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "Content-Type": "application/json"
        },
      })
      .then(response => {
        if (response.ok) {
          btn.textContent = action === "follow" ? "–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—å" : "–í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏";

          const countElem = document.getElementById("followers-count");
          let currentCount = parseInt(countElem.textContent);
          countElem.textContent = action === "follow" ? currentCount + 1 : currentCount - 1;
        } else {
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–ø–∏—Å–∫–∏:", response.status);
        }
      })
      .catch(err => {
        console.error("–ó–∞–ø–∏—Ç –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ:", err);
      });
    });
  });
  </script>

</body>
</html>